<!DOCTYPE html>
<html>
<head>
    <title>Convo-Master</title>
    <link rel="stylesheet" type="text/css" href="/static/styles.css">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>

<div class="header-with-icon">
        <img src="{{ url_for('static', filename='favicon.ico') }}" alt="Site Icon" style="width: 32px; height: 32px; vertical-align: middle;">
        <h2 style="display: inline; margin-left: 10px;">Convo-Master</h2>
</div>

<!-- <div class="avatar-container">
    <img id="avatar" src="{{ url_for('static', filename='not-speaking.png') }}" alt="Avatar" style="width: 100px; height: auto;">
</div> -->

<div class="main-content">
<div>
    <h4>You could ask:</h4>
    <ul>
        <li>Can you pronounce a-p-p-l-e for me?</li>
        <li>How to say 'Good Morning' in spanish?</li>
        <li>I am feeling a bit tired, can we play a word game?</li>
        <li>Give me three English words that are synonyms to happy.</li>
    </ul>
</div>

<div class="buttons-container">
<button onclick="startRecording()">Start Talking</button>
<button onclick="stopRecording()" disabled>Hit this button when you are done.</button>
</div>
<!-- Start of Avatar -->
<body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width=960 height=600 tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"> </div>
      <div id="unity-footer">
        <div id="unity-webgl-logo"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">convo-ai</div>
      </div>
    </div>
    <script>

      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var fullscreenButton = document.querySelector("#unity-fullscreen-button");
      var warningBanner = document.querySelector("#unity-warning");

      function unityShowBanner(msg, type) {
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function() {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      var buildUrl = "/static/Build";
      var loaderUrl = buildUrl + "/unity-avatar.loader.js";
      var config = {
        dataUrl: buildUrl + "/unity-avatar.data",
        frameworkUrl: buildUrl + "/unity-avatar.framework.js",
        codeUrl: buildUrl + "/unity-avatar.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "convo-ai",
        productVersion: "0.1",
        showBanner: unityShowBanner,
      };

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        // Mobile device style: fill the whole browser client area with the game canvas:

        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);
        container.className = "unity-mobile";
        canvas.className = "unity-mobile";
        // To lower canvas resolution on mobile devices to gain some
        // performance, uncomment the following line:
        // config.devicePixelRatio = 1;


      } else {
        // Desktop style: Render the game canvas in a window that can be maximized to fullscreen:

        canvas.style.width = "480px";
        canvas.style.height = "300px";
      }

      loadingBar.style.display = "block";
      var unityInstance;

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
              }).then((instance) => {
                unityInstance = instance
                loadingBar.style.display = "none";
                fullscreenButton.onclick = () => {
                  instance.SetFullscreen(1);
                };
              }).catch((message) => {
                alert(message);
              });
            };

      document.body.appendChild(script);
    //   script.
    //   unityInstance = script.unityInstance;
    </script>
  </body>
<!-- End of Avatar -->


<!-- <script src="{{ url_for('static', filename='/Build/unity-avatar.loader.js') }}"></script> -->

<!-- <script>
  var unityInstance = UnityLoader.instantiate("unity-container", "static/Build/unity-avatar.loader.js", {onProgress: UnityProgress});
</script> -->

<div id="chatBox" class="chat-box">
    <div id="loader" class="loader" style="display: none;">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
</div>

<script>
let mediaRecorder;
let audioChunks = [];

function startRecording() {
    document.getElementById('loader').style.display = 'none';
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.wav');
                
                document.getElementById('loader').style.display = 'flex';
                fetch('/upload', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loader').style.display = 'none';
                    if(data.response) {
                        appendMessage("Convo-Master: " + data.response, 'gpt-response');
                        // Request the speech audio for the response
                        fetch('/text-to-speech', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({text: data.response}),
                        })
                        .then(response => response.json())
                        .then(speechData => {
                            if(speechData.speech_url) {
                                var audio = new Audio(speechData.speech_url);
                                
                                audio.play();
                                audio.onplay = function() {
                                    // Change avatar to 'speaking' state before playing audio
                                    // document.getElementById('avatar').src = "{{ url_for('static', filename='speaking.png') }}";
                                    function trySendMessage() {
                                        if (unityInstance) {
                                            unityInstance.SendMessage('avatar', 'StartTalking');
                                        } else {
                                            console.error("Unity instance is not ready.");
                                        }
                                    }
                                }

                                audio.onended = function() {
                                    const filename = speechData.speech_url.split('/').pop();
                                    // document.getElementById('avatar').src = "{{ url_for('static', filename='not-speaking.png') }}";
                                    // Once audio has finished playing, send request to delete the file
                                    fetch('/delete-speech', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({filename: filename}) // Assuming you return the filename from the server
                                    })
                                    .then(response => console.log('Speech file deleted successfully'))
                                    .then(() => {
                                        if (unityInstance) {
                                            unityInstance.SendMessage('avatar', 'StopTalking')
                                        } else {
                                            console.error("Unity instance is not ready.")
                                        }
                                    })
                                    .catch(error => console.error('Error deleting speech file:', error));
                                    
                                };

                            }
                        })
                        .catch(error => console.error('Error fetching speech audio:', error));
                    } else if(data.error) {
                        appendMessage("Error: " + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loader').style.display = 'none';
                    appendMessage("Error: " + error, 'error');
                });
                
                audioChunks = [];
            };
            mediaRecorder.start();
            document.querySelector("button[onclick='startRecording()']").disabled = true;
            document.querySelector("button[onclick='stopRecording()']").disabled = false;
        });
}

function stopRecording() {
    mediaRecorder.stop();
    document.querySelector("button[onclick='startRecording()']").disabled = false;
    document.querySelector("button[onclick='stopRecording()']").disabled = true;
}

function appendMessage(message, className) {
    const messageDiv = document.createElement('div');
    messageDiv.className = className;
    messageDiv.textContent = message;
    document.getElementById('chatBox').appendChild(messageDiv);
}
</script>
</div>
</body>
</html>
